<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STARK Benchmark Visualizer</title>
    <!-- Bootstrap for UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js for graphs -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { padding: 20px; }
        .plot-container { height: 400px; margin: 20px 0; }
        select[multiple] { height: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive STARK Benchmark Visualizer</h1>
        <p>Select options below to visualize proof size, prover time, and verify time vs. k for different arities.</p>

        <!-- Controls -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="machineSelect" class="form-label">Machine Type (CSV File)</label>
                <select id="machineSelect" class="form-select">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="col-md-4">
                <label for="aritySelect" class="form-label">Arities (Schedules) - Hold Ctrl/Cmd for multi-select</label>
                <select id="aritySelect" class="form-select" multiple>
                    <!-- Populated by JS -->
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">k Range</label>
                <div class="row">
                    <div class="col-6">
                        <input type="number" id="kMin" class="form-control" value="11" min="11" max="25" placeholder="Min k">
                    </div>
                    <div class="col-6">
                        <input type="number" id="kMax" class="form-control" value="25" min="11" max="25" placeholder="Max k">
                    </div>
                </div>
            </div>
        </div>
        <button id="updateBtn" class="btn btn-primary mb-3">Update Graphs</button>

        <!-- Graphs -->
        <div id="proofSizePlot" class="plot-container"></div>
        <div id="proverTimePlot" class="plot-container"></div>
        <div id="verifyTimePlot" class="plot-container"></div>
    </div>

    <script>
        // Configuration: Replace with your repo details
        const csvUrls = [
            { label: 'C5 AVX512 XLarge (R26, Dual-Hash, Goldilocks, Blake3)', url: 'https://raw.githubusercontent.com/{username}/{repo}/main/results/final-c5-avx512-xlarge-r26-fullprotocol-dual-hash-goldilocks-blake3-e3.csv' },
            // Add your other 8 CSVs here, e.g.:
            // { label: 'Another Machine (e.g., C5 Smaller)', url: 'https://raw.githubusercontent.com/{username}/{repo}/main/data/another-file.csv' },
            // ... (total 9)
        ];

        let allData = {}; // { machineLabel: parsed CSV data }

        // Load all CSVs on page load
        async function loadData() {
            const machineSelect = document.getElementById('machineSelect');
            csvUrls.forEach(({ label, url }) => {
                const option = document.createElement('option');
                option.value = label;
                option.textContent = label;
                machineSelect.appendChild(option);

                // Fetch and parse CSV
                Papa.parse(url, {
                    download: true,
                    header: true,
                    complete: (results) => {
                        allData[label] = results.data.filter(row => row.k && !isNaN(row.k)); // Filter valid rows
                        console.log(`Loaded ${label}: ${allData[label].length} rows`);
                    },
                    error: (err) => console.error(`Error loading ${label}:`, err)
                });
            });
        }

        // Extract unique arities for a machine
        function getUniqueArities(machineLabel) {
            const data = allData[machineLabel];
            if (!data) return [];
            const arities = [...new Set(data.map(row => row.schedule).filter(s => s))];
            return arities.sort();
        }

        // Update arity dropdown when machine changes
        document.getElementById('machineSelect').addEventListener('change', (e) => {
            const machineLabel = e.target.value;
            const aritySelect = document.getElementById('aritySelect');
            aritySelect.innerHTML = ''; // Clear
            getUniqueArities(machineLabel).forEach(arity => {
                const option = document.createElement('option');
                option.value = arity;
                option.textContent = arity;
                aritySelect.appendChild(option);
            });
            // Auto-select first 3 arities if available
            for (let i = 0; i < Math.min(3, aritySelect.options.length); i++) {
                aritySelect.options[i].selected = true;
            }
            updateGraphs(); // Auto-update
        });

        // Update graphs on button click or k change
        document.getElementById('updateBtn').addEventListener('click', updateGraphs);
        document.getElementById('kMin').addEventListener('input', updateGraphs);
        document.getElementById('kMax').addEventListener('input', updateGraphs);

        function updateGraphs() {
            const machineLabel = document.getElementById('machineSelect').value;
            const selectedArities = Array.from(document.getElementById('aritySelect').selectedOptions).map(opt => opt.value);
            const kMin = parseInt(document.getElementById('kMin').value) || 11;
            const kMax = parseInt(document.getElementById('kMax').value) || 25;

            if (!machineLabel || selectedArities.length === 0) {
                console.warn('No selection'); return;
            }

            const data = allData[machineLabel];
            if (!data) return;

            // Filter data
            const filteredData = data.filter(row => 
                selectedArities.includes(row.schedule) &&
                parseInt(row.k) >= kMin && parseInt(row.k) <= kMax
            );

            // Group by arity for multi-line plots
            const tracesByArity = {};
            selectedArities.forEach(arity => {
                const arityData = filteredData.filter(row => row.schedule === arity);
                if (arityData.length > 0) {
                    const kVals = arityData.map(row => parseInt(row.k)).sort((a, b) => a - b);
                    const proofBytes = kVals.map(k => {
                        const row = arityData.find(r => parseInt(r.k) === k);
                        return parseFloat(row?.proof_bytes) || null;
                    });
                    const proveS = kVals.map(k => {
                        const row = arityData.find(r => parseInt(r.k) === k);
                        return parseFloat(row?.prove_s) || null;
                    });
                    const verifyMs = kVals.map(k => {
                        const row = arityData.find(r => parseInt(r.k) === k);
                        return parseFloat(row?.verify_ms) || null;
                    });

                    tracesByArity[arity] = { k: kVals, proofBytes, proveS, verifyMs };
                }
            });

            // Plot Proof Size
            const proofTraces = Object.entries(tracesByArity).map(([arity, vals]) => ({
                x: vals.k,
                y: vals.proofBytes,
                type: 'scatter',
                mode: 'lines+markers',
                name: arity,
                line: { shape: 'linear' }
            }));
            Plotly.newPlot('proofSizePlot', proofTraces, {
                title: 'Proof Size (bytes) vs. k',
                xaxis: { title: 'k' },
                yaxis: { title: 'Proof Bytes' }
            });

            // Plot Prover Time
            const proverTraces = Object.entries(tracesByArity).map(([arity, vals]) => ({
                x: vals.k,
                y: vals.proveS,
                type: 'scatter',
                mode: 'lines+markers',
                name: arity,
                line: { shape: 'linear' }
            }));
            Plotly.newPlot('proverTimePlot', proverTraces, {
                title: 'Prover Time (s) vs. k',
                xaxis: { title: 'k' },
                yaxis: { title: 'Prove Time (s)' }
            });

            // Plot Verify Time
            const verifyTraces = Object.entries(tracesByArity).map(([arity, vals]) => ({
                x: vals.k,
                y: vals.verifyMs,
                type: 'scatter',
                mode: 'lines+markers',
                name: arity,
                line: { shape: 'linear' }
            }));
            Plotly.newPlot('verifyTimePlot', verifyTraces, {
                title: 'Verify Time (ms) vs. k',
                xaxis: { title: 'k' },
                yaxis: { title: 'Verify Time (ms)' }
            });
        }

        // Init
        loadData();
        // Trigger initial load (select first machine)
        setTimeout(() => {
            document.getElementById('machineSelect').selectedIndex = 0;
            document.getElementById('machineSelect').dispatchEvent(new Event('change'));
        }, 2000); // Delay for data load
    </script>
</body>
</html>
